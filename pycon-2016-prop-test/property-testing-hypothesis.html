<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Don't write tests, Generate them!</title>
<meta name="author" content="(Puneeth Chaganti)"/>
<style type="text/css">
.underline { text-decoration: underline; }
</style>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/reveal.js/3.0.0/css/reveal.css"/>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/reveal.js/3.0.0/css/theme/white.css" id="theme"/>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/reveal.js/3.0.0/lib/css/zenburn.css"/>
<!-- If the query includes 'print-pdf', include the PDF print sheet -->
<script>
    if( window.location.search.match( /print-pdf/gi ) ) {
        var link = document.createElement( 'link' );
        link.rel = 'stylesheet';
        link.type = 'text/css';
        link.href = 'https://cdn.jsdelivr.net/reveal.js/3.0.0/css/print/pdf.css';
        document.getElementsByTagName( 'head' )[0].appendChild( link );
    }
</script>
</head>
<body>
<div class="reveal">
<div class="slides">
<section id="sec-title-slide"><h1 class="title">Don't write tests, Generate them!</h1><h2 class="author">Puneeth Chaganti</h2>
</section>

<section>
<section id="slide-org6648195">
<h2 id="org6648195">Introduction</h2>
<div class="outline-text-2" id="text-org6648195">
</div></section>
</section>
<section>
<section id="slide-org16e09da">
<h3 id="org16e09da">Property-based testing, anyone?</h3>
</section>
</section>
<section>
<section id="slide-org4b93331">
<h3 id="org4b93331">A typical test-suite</h3>
<div class="org-src-container">

<pre><code class="python" >def test_strip_whitespace_with_no_argument():
    assert strip('  foo ') == 'foo'

def test_should_strip_whitespace_with_argument():
    assert strip('  foo ', ' ') == 'foo'

def test_should_strip_non_whitespace():
    assert strip('foo', 'fo') == ''

...
</code></pre>
</div>
</section>
</section>
<section>
<section id="slide-org2a3f19f">
<h3 id="org2a3f19f">Example based tests</h3>
<dl>
<dt>Given</dt><dd>Setup some <b>example</b> data</dd>
<dt>When</dt><dd>Perform actions</dd>
<dt>Then</dt><dd><code>assert output == expected</code></dd>

</dl>

</section>
</section>
<section>
<section id="slide-orgca51579">
<h3 id="orgca51579">Problems?</h3>
<ul>
<li>Combinatorial explosion</li>
<li>Biases carry-over to tests</li>
<li>Tedious</li>

</ul>
</section>
<section id="slide-org3f209e2">
<h4 id="org3f209e2">State in a website</h4>

<div class="figure">
<p><img src="./state-website.jpg" alt="state-website.jpg" />
</p>
</div>
</section>
</section>
<section>
<section id="slide-org2afcbbe">
<h3 id="org2afcbbe">Enter Generative testing</h3>
<p>
(Property-based testing)
</p>
</section>
<section id="slide-org97759bb">
<h4 id="org97759bb">Property-based test, the hard way</h4>
<div class="org-src-container">

<pre><code class="python" >def test_strip_random():
    for _ in range(200):
        s = random_string()
        strip_chars = random_string()
        S = strip(s, strip_chars)
        assert is_stripped(S, s, strip_chars)

def is_stripped(S, s, strip_chars):
    assert len(S) <= len(s)
    if len(S) > 0:
        assert S[0] not in set(strip_chars)
        assert S[-1] not in set(strip_chars)
    return True

random_string = [
    random.choice(string.ascii_letters)
    for _ in range(10)
]
</code></pre>
</div>


</section>
<section id="slide-orgea1ba92">
<h4 id="orgea1ba92">Property based tests</h4>
<dl>
<dt>Given</dt><dd>For <b>random</b> data matching a spec</dd>
<dt>When</dt><dd>Perform actions</dd>
<dt>Then</dt><dd><code>assert property(output)</code></dd>

</dl>

</section>
</section>
<section>
<section id="slide-org2993e71">
<h2 id="org2993e71">Hypothesis - Property based testing for Python</h2>
<div class="outline-text-2" id="text-org2993e71">
</div></section>
</section>
<section>
<section id="slide-org5ba8fe1">
<h3 id="org5ba8fe1">Hypothesized test</h3>
<div class="org-src-container">

<pre><code class="python" >from hypothesis import given, strategies as st

@given(st.text(), st.text())
def test_strip_hypothesis(s, strip_chars):
    S = strip(s, strip_chars)
    assert is_stripped(S, s, strip_chars)
# Ran 1 test in 0.159s
</code></pre>
</div>

</section>
<section id="slide-orgf17f18b">
<h4 id="orgf17f18b">Failing output</h4>
<div class="org-src-container">

<pre><code class="python" >strip = lambda x, y: x.lstrip(y)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

output = '01', input_ = '01', strip_chars = '1'

    def is_stripped(output, input_, strip_chars):
        assert len(output) <= len(input_)
        if len(output) > 0:
            assert output[0] not in set(strip_chars)
>           assert output[-1] not in set(strip_chars)
E           assert '1' not in {'1'}
E            +  where {'1'} = set('1')

test_code.py:113: AssertionError
----------------------------------------------------- Hypothesis ------------------------------------------------------
Falsifying example: test_strip(s='01', strip_chars='1')
</code></pre>
</div>

</section>
</section>
<section>
<section id="slide-org77b539a">
<h3 id="org77b539a">Shrinking</h3>
<ul>
<li>Random data has lots of noise</li>
<li>Try to find the "simplest" failing case</li>

</ul>
<p>
To learn more, see <a href="https://github.com/HypothesisWorks/hypothesis-python/blob/7c54198d31a5035a0c2810d8c500308f507b5b11/notebooks/Designing%20a%20better%20simplifier.ipynb">Designing a better simplifier</a>
</p>

</section>
</section>
<section>
<section id="slide-orge3dae58">
<h3 id="orge3dae58">Data generation</h3>
<div class="outline-text-3" id="text-orge3dae58">
</div></section>
<section id="slide-org328eada">
<h4 id="org328eada">Generators for built-ins</h4>
<div class="org-src-container">

<pre><code class="python" >from hypothesis import strategies as st

def sample(strategy, n=3):
    return [strategy.example() for _ in range(n)]

print(sample(st.integers()))
print(sample(st.floats()))
print(sample(st.complex_numbers()))
print(sample(st.text(max_size=3)))
print(sample(st.lists(st.integers())))
</code></pre>
</div>

<pre class="example">
[-7435755662106, -49, -1295624]
[-9.266256382731017e+17, -0.19780830243100944, -2.4010523231296193e+61]
[(-0.99999-0.99999j), (-2.220446049250313e-16+nanj), (0.003554608069336136-1.923176004582495e-275j)]
['', '\U000ded7f9', '']
[[52647858669059, -31758544979, 71365626], [0], []]
</pre>
</section>
<section id="slide-org369e3cf">
<h4 id="org369e3cf">Extra generators</h4>
<ul>
<li>Django models</li>
<li>Numpy arrays</li>
<li>Dates &amp; times</li>
<li>Faker generators</li>

</ul>
</section>
<section id="slide-org17284fb">
<h4 id="org17284fb">Composable strategies</h4>
<div class="org-src-container">

<pre><code class="x" >from hypothesis import strategies as st

st.recursive?
st.one_of?
st.builds?
st.streaming?

.map, .filter, .flatmap
</code></pre>
</div>

</section>
<section id="slide-org1277189">
<h4 id="org1277189">Composing strategies - Example</h4>
<div class="org-src-container">

<pre><code class="python" >rows = [('John', 'Adams', 90), (...), (...)]
headers = ['first_name', 'last_name', 'gpa']
print(tablib.Dataset(*rows, headers=headers))
</code></pre>
</div>

<div class="org-src-container">

<pre><code class="markdown" >first_name|last_name |gpa
----------|----------|---
John      |Adams     |90
George    |Washington|67
Thomas    |Jefferson |50
</code></pre>
</div>

</section>
<section id="slide-org8196cf7">
<h4 id="org8196cf7">Generate Rows &amp; Header</h4>
<div class="org-src-container">

<pre><code class="python" >from hypothesis import strategies as st; import string

n = 3
alphabet = string.ascii_letters
generate_row = st.tuples(
    st.text(alphabet, min_size=1),
    st.text(alphabet, min_size=1),
    st.integers(min_value=0, max_value=100)
)
generate_table = st.lists(generate_row, min_size=3, max_size=3)
generate_headers = st.lists(
    st.text(alphabet, min_size=1),
    unique=True,
    min_size=n,
    max_size=n
)
</code></pre>
</div>
</section>
<section id="slide-org1a01788">
<h4 id="org1a01788">Putting it together</h4>
<div class="org-src-container">

<pre><code class="python" >def create_dataset(rows, headers):
    return tablib.Dataset(*rows, headers=headers)

def generate_dataset():
    return st.builds(create_dataset, generate_data, headers=generate_headers)

print(generate_dataset().example())
</code></pre>
</div>

<div class="org-src-container">

<pre><code class="x" >znefubbdv     |wpclcf|ouc
--------------|------|---
aecpjxzwfqosmu|krlmfh|55
htq           |jid   |87
lwbfboxyifre  |oqdha |83
</code></pre>
</div>


</section>
</section>
<section>
<section id="slide-orgda991f9">
<h3 id="orgda991f9">Simple <code>tablib</code> test</h3>
<div class="org-src-container">

<pre><code class="python" >def test_add_column():
    rows = [['kenneth'], ['bessie']]
    data = tablib.Dataset(*rows, headers=['fname'])
    new_col = ['reitz', 'monke']
    data.append_col(new_col, header='lname')

    assert data[0] == ('kenneth', 'reitz'))
    assert data.width == 2
</code></pre>
</div>
</section>
<section id="slide-org5315788">
<h4 id="org5315788">to a property based test</h4>
<div class="org-src-container">

<pre><code class="python" >@given(data=generate_dataset(),
       new_col=st.lists(st.text(min_size=1), min_size=3, max_size=3),
       header=st.text(min_size=3))
def test_hyp_add_column(data, new_col, header):
    first_row = data[0]
    data.append_col(new_col, header=header)

    assert data[0] == first_row + (new_col[0],)
    assert data.width == 4
</code></pre>
</div>
</section>
<section id="slide-orgea3811f">
<h4 id="orgea3811f">Test transpose</h4>
<div class="org-src-container">

<pre><code class="python" >@given(generate_dataset())
def test_transpose(self, data):
    data_ = data.transpose()

    self.assertEqual(data.width, data_.height+1)
    self.assertEqual(data.height, data_.width-1)
</code></pre>
</div>
</section>
<section id="slide-orgbf4ed4a">
<h4 id="orgbf4ed4a">Round trip transpose</h4>
<div class="org-src-container">

<pre><code class="python" >@given(generate_dataset())
def test_two_transposes(self, data):
    data_ = data.transpose().transpose()

    self.assertEqual(data.width, data_.width)
    self.assertEqual(data.height, data_.height)
</code></pre>
</div>

<div class="org-src-container">

<pre><code class="traceback" >    self.assertEqual(data.width, data_.height)
E   AssertionError: 3 != 2
------------------------------------------------ Captured stdout call -------------------------------------------------
Falsifying example:
a|b|c
-|-|-
a|a|0
a|a|0
a|a|0
</code></pre>
</div>
</section>
<section id="slide-org1eb2994">
<h4 id="org1eb2994">Round trip to json</h4>
<div class="org-src-container">

<pre><code class="python" >@given(generate_dataset())
def test_json_export_import_works(data):
    json_ = data.json
    data_ = tablib.import_set(json_)

    self.assertEqual(data.width, data_.width)
    self.assertEqual(data.height, data_.height)
    self.assertEqual(data[0], data_[0]))
</code></pre>
</div>

<div class="org-src-container">

<pre><code class="traceback" >    self.assertEqual(data[0], data_[0])
E   AssertionError: Tuples differ: ('a', 'a', 0) != ('a', 0, 'a')
</code></pre>
</div>
</section>
</section>
<section>
<section id="slide-orgbb3844b">
<h3 id="orgbb3844b">Verification</h3>
<p>
<code>strip</code> tests from before
</p>

<p>
Sorting actually returns a sorted list
</p>


</section>
<section id="slide-org82b8010">
<h4 id="org82b8010">Computing the mean</h4>
<div class="org-src-container">

<pre><code class="python" >from hypothesis import given, strategies as st

@given(st.lists(st.floats(allow_nan=False, allow_infinity=False)), min_size=1)
def test_mean_is_within_reasonable_bounds(ls):
    assert min(ls) <= mean(ls) <= max(ls)
</code></pre>
</div>


</section>
<section id="slide-orgff28309">
<h4 id="orgff28309">Going by definition &#x2026;</h4>
<div class="org-src-container">

<pre><code class="python" >def mean(xs):
    return sum(xs) / len(xs)
</code></pre>
</div>

<pre class="example">
ls = [8.988465674311579e+307, 8.98846567431158e+307]

    @given(st.lists(st.floats(allow_nan=False, allow_infinity=False), min_size=1))
    def test_mean_is_within_reasonable_bounds(ls):
&gt;       assert min(ls) &lt;= mean(ls) &lt;= max(ls)
E       assert inf &lt;= 8.98846567431158e+307
E        +  where inf = mean([8.988465674311579e+307, 8.98846567431158e+307])
E        +  and   8.98846567431158e+307 = max([8.988465674311579e+307, 8.98846567431158e+307])
</pre>


</section>
<section id="slide-org5ce150f">
<h4 id="org5ce150f">Avoiding overflow</h4>
<div class="org-src-container">

<pre><code class="python" >def mean(xs):
    n = len(xs)
    return sum(x / n  for x in xs)
</code></pre>
</div>

<pre class="example">
ls = [1.390671161567e-309, 1.390671161567e-309, 1.390671161567e-309]

    @given(st.lists(st.floats(allow_nan=False, allow_infinity=False), min_size=1))
    def test_mean_is_within_reasonable_bounds(ls):
&gt;       assert min(ls) &lt;= mean(ls) &lt;= max(ls)
E       assert 1.390671161567e-309 &lt;= 1.390671161566996e-309
E        +  where 1.390671161567e-309 = min([1.390671161567e-309, 1.390671161567e-309, 1.390671161567e-309])
E        +  and   1.390671161566996e-309 = mean([1.390671161567e-309, 1.390671161567e-309, 1.390671161567e-309])
</pre>


</section>
<section id="slide-org7833e36">
<h4 id="org7833e36">For instance, <code>numpy</code></h4>
<div class="org-src-container">

<pre><code class="python" >import numpy as np
def mean(xs):
    return np.array(xs).mean()
</code></pre>
</div>

<pre class="example">
ls = [8.988465674311579e+307, 8.98846567431158e+307]

    @given(st.lists(st.floats(allow_nan=False, allow_infinity=False), min_size=1))
    def test_mean_is_within_reasonable_bounds(ls):
&gt;       assert min(ls) &lt;= mean(ls) &lt;= max(ls)
E       assert inf &lt;= 8.98846567431158e+307
E        +  where inf = mean([8.988465674311579e+307, 8.98846567431158e+307])
E        +  and   8.98846567431158e+307 = max([8.988465674311579e+307, 8.98846567431158e+307])
</pre>

<p>
Read this <a href="https://hal.archives-ouvertes.fr/file/index/docid/576641/filename/computing-midpoint.pdf">30 page paper</a>, to see how to do it right!
</p>

</section>
</section>
<section>
<section id="slide-org3e1d897">
<h3 id="org3e1d897">Test Oracle</h3>
<div class="org-src-container">

<pre><code class="python" >from hypothesis import strategies as st, given
from my_lib import my_sort

@given(st.lists(st.integers()))
def test_my_sort(xs):
    assert sorted(xs) == my_sort(xs)
</code></pre>
</div>


</section>
</section>
<section>
<section id="slide-org507b895">
<h3 id="org507b895">More patterns</h3>
<p>
See talk by <a href="http://pyvideo.org/pycon-za-2015/property-based-testing-with-hypothesis.html">Jeremy Thurgood</a>
</p>
<ul>
<li>Induction</li>
<li>Transformation</li>
<li>Invariance</li>
<li>Idempotence</li>

</ul>
</section>
</section>
<section>
<section id="slide-org563eca1">
<h3 id="org563eca1">Keep in mind</h3>
<ul>
<li>Fast data generation</li>
<li>Fast assertions</li>
<li>Simple looking, yet powerful</li>
<li>Re-use?</li>

</ul>

</section>
</section>
<section>
<section id="slide-orgcd99af7">
<h2 id="orgcd99af7">Stateful testing</h2>
<div class="org-src-container">

<pre><code class="python" >def test_website():
    assert login(credentials)
    assert go_to_homepage()
    assert follow_friend()
    assert logout()
</code></pre>
</div>


</section>
</section>
<section>
<section id="slide-org6d2a1ad">
<h3 id="org6d2a1ad">Pseudocode example</h3>
<div class="org-src-container">

<pre><code class="python" >class WebSiteStateMachine(RuleBasedStateMachine):
    def __init__(self):
        super(WebSiteStateMachine, self).__init__()

    def login(self):
        """Login using credentials and assert success."""

    @rule()
    def logout(self):
        """Logout and assert it worksn."""

    @rule(user=st.sampled_from(USERS))
    def follow_user(self, user):
        """Assert that following a user works."""

WebSiteTestCase = WebSiteStateMachine.TestCase
</code></pre>
</div>

</section>
</section>
<section>
<section id="slide-orgdc72793">
<h2 id="orgdc72793">Problems with Generative Testing?</h2>
<ul>
<li>Performance</li>
<li>Debugging CI failures</li>
<li>Rare branches?</li>

</ul>
</section>
</section>
<section>
<section id="slide-org7ade77d">
<h2 id="org7ade77d">Conclusion</h2>
<div class="outline-text-2" id="text-org7ade77d">
</div></section>
</section>
<section>
<section id="slide-orgceab927">
<h3 id="orgceab927">Property based tests</h3>
<ul>
<li>Concise</li>
<li>Overcome developer biases</li>
<li>Assert general things</li>

</ul>
</section>
</section>
<section>
<section id="slide-org3070234">
<h3 id="org3070234">Hypothesis</h3>
<ul>
<li>Generate data, given a requirement</li>
<li>Check that a <b>property</b> holds true</li>
<li>Shrink failed cases to simplest case</li>

</ul>
</section>
</section>
<section>
<section id="slide-orgc7d6eb0">
<h3 id="orgc7d6eb0">Some interesting case studies</h3>
<ul>
<li><a href="https://vimeo.com/68383317">John Hughes</a>: Testing the hard stuff and staying sane</li>
<li><a href="https://www.youtube.com/watch?v=HXGpBrmR70U">Ashton Kemerling</a>: Generative Integration Testing</li>
<li><a href="https://www.youtube.com/watch?v=Yp7MmskzF9Y">Sean Grove</a>: Generating and Running 1M tests</li>

</ul>
</section>
</section>
<section>
<section id="slide-org82310c7">
<h3 id="org82310c7">Pairing anyone?</h3>
</section>
</section>
<section>
<section id="slide-orge40c559">
<h3 id="orge40c559">Thank you</h3>
<p>
@punchagan
</p>

<p>
<a href="http://tinyurl.com/pygentest">http://tinyurl.com/pygentest</a>
</p>
</section>
</section>
</div>
</div>
<script src="https://cdn.jsdelivr.net/reveal.js/3.0.0/lib/js/head.min.js"></script>
<script src="https://cdn.jsdelivr.net/reveal.js/3.0.0/js/reveal.js"></script>

<script>
// Full list of configuration options available here:
// https://github.com/hakimel/reveal.js#configuration
Reveal.initialize({

controls: true,
progress: true,
history: true,
center: true,
slideNumber: 'c',
rollingLinks: true,
keyboard: true,
overview: true,
width: 800,
height: 600,
margin: 0.10,
minScale: 0.20,
maxScale: 300.00,

theme: Reveal.getQueryHash().theme, // available themes are in /css/theme
transition: Reveal.getQueryHash().transition || 'cube', // default/cube/page/concave/zoom/linear/fade/none
transitionSpeed: 'default',
multiplex: {
    secret: '', // null if client
    id: '', // id, obtained from socket.io server
    url: '' // Location of socket.io server
},

// Optional libraries used to extend on reveal.js
dependencies: [
 { src: 'https://cdn.jsdelivr.net/reveal.js/3.0.0/plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
 { src: 'https://cdn.jsdelivr.net/reveal.js/3.0.0/plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } },
 { src: '', async: true },
 { src: 'https://cdn.jsdelivr.net/reveal.js/3.0.0/plugin/multiplex/master.js', async: true },
 { src: 'https://cdn.jsdelivr.net/reveal.js/3.0.0/plugin/zoom-js/zoom.js', async: true, condition: function() { return !!document.body.classList; } }]
});
</script>
</body>
</html>
